import { Button, LineEdit, ListView, Palette } from "std-widgets.slint";

export struct CollectionTreeRow {
    id: string,
    label: string,
    depth: int,
    has-children: bool,
    is-expanded: bool,
}

export struct VaultItemRow {
    label: string,
}

export struct VaultItemFieldRow {
    label: string,
    value: string,
}

export component MainWindow inherits Window {
    preferred-width: 1000px;
    preferred-height: 700px;
    min-width: 500px;
    min-height: 500px;
    title: root.is-vault-view ? "Bitwarden Vault" : "Bitwarden Login";
    background: root.color-bg-app;

    callback login-requested();
    callback sso-login-requested();
    callback sso-master-password-submitted();
    callback tde-approval-cancel-requested();
    init => {
        Palette.color-scheme = ColorScheme.dark;
    }
    property <color> color-bg-app: #0a111d;
    property <color> color-bg-panel: #111b2d;
    property <color> color-bg-elevated: #16243a;
    property <color> color-bg-subtle: #1a2a42;
    property <color> color-bg-card: #101a2b;
    property <color> color-border: #2b3d59;
    property <color> color-text-primary: #e6edf8;
    property <color> color-text-secondary: #9cb0cb;
    property <color> color-text-muted: #7d92af;
    property <color> color-accent-soft: #223a66;
    property <color> color-success: #45c287;
    property <color> color-error: #ff6f86;
    in-out property <string> server-url: "https://vault.bitwarden.com";
    in-out property <string> username;
    in-out property <string> password;
    in-out property <string> status-text;
    in-out property <bool> status-is-error;
    in-out property <bool> is-logging-in;
    in-out property <bool> is-vault-view;
    in-out property <string> sso-identifier;
    in-out property <bool> is-sso-awaiting-password;
    in-out property <string> sso-master-password;
    in-out property <bool> is-tde-awaiting-approval;
    in-out property <string> tde-fingerprint;
    in-out property <[CollectionTreeRow]> collection-tree-rows;
    in-out property <string> active-collection-id;
    in-out property <[VaultItemRow]> vault-item-rows;
    in-out property <string> search-query;
    in-out property <bool> has-active-search;
    in-out property <int> selected-vault-item-index: -1;
    in-out property <string> selected-vault-item-title;
    in-out property <[VaultItemFieldRow]> selected-vault-item-fields;
    in-out property <string> selected-vault-item-empty-text;
    in-out property <bool> selected-has-password;
    in-out property <bool> is-password-visible;
    callback collection-tree-row-clicked(int);
    callback collection-all-items-clicked();
    callback vault-item-clicked(int);
    callback search-requested();
    callback toggle-password-visibility();

    Rectangle {
        background: root.color-bg-app;

        Rectangle {
            width: parent.width > 700px ? 620px : parent.width - 80px;
            height: parent.height > 700px ? 620px : parent.height - 80px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: root.color-bg-panel;
            border-width: 1px;
            border-color: root.color-border;
            border-radius: 10px;
            visible: !root.is-vault-view && !root.is-sso-awaiting-password && !root.is-tde-awaiting-approval;

            VerticalLayout {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 20px;
                padding-bottom: 20px;
                spacing: 10px;

                Text {
                    text: "Sign in to Bitwarden";
                    color: root.color-text-primary;
                    font-size: 24px;
                    font-weight: 700;
                }

                Text {
                    text: "Use cloud or a self-hosted server.";
                    color: root.color-text-secondary;
                    font-size: 14px;
                }

                Text {
                    text: "Server URL";
                    color: root.color-text-primary;
                    font-size: 14px;
                }

                LineEdit {
                    text <=> root.server-url;
                    placeholder-text: "https://vault.bitwarden.com";
                    enabled: !root.is-logging-in;
                }

                Text {
                    text: "Username";
                    color: root.color-text-primary;
                    font-size: 14px;
                }

                LineEdit {
                    text <=> root.username;
                    placeholder-text: "name@example.com";
                    enabled: !root.is-logging-in;
                }

                Text {
                    text: "Password";
                    color: root.color-text-primary;
                    font-size: 14px;
                }

                LineEdit {
                    text <=> root.password;
                    placeholder-text: "Enter your password";
                    input-type: InputType.password;
                    enabled: !root.is-logging-in;
                }

                Rectangle {
                    height: 4px;
                    background: transparent;
                }

                Text {
                    text: root.status-text;
                    color: root.status-is-error ? root.color-error : root.color-success;
                    font-size: 13px;
                    wrap: word-wrap;
                    visible: root.status-text != "";
                }

                Button {
                    text: root.is-logging-in ? "Logging in..." : "Log in";
                    enabled: !root.is-logging-in;
                    clicked => {
                        root.login-requested();
                    }
                }

                Rectangle {
                    height: 1px;
                    background: root.color-border;
                }

                Text {
                    text: "Enterprise Single Sign-On";
                    color: root.color-text-primary;
                    font-size: 14px;
                    font-weight: 600;
                }

                Text {
                    text: "SSO Identifier";
                    color: root.color-text-primary;
                    font-size: 14px;
                }

                LineEdit {
                    text <=> root.sso-identifier;
                    placeholder-text: "Organization SSO identifier";
                    enabled: !root.is-logging-in;
                }

                Button {
                    text: root.is-logging-in ? "Logging in..." : "SSO Login";
                    enabled: !root.is-logging-in;
                    clicked => {
                        root.sso-login-requested();
                    }
                }
            }
        }

        Rectangle {
            width: parent.width > 700px ? 480px : parent.width - 80px;
            height: 320px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: root.color-bg-panel;
            border-width: 1px;
            border-color: root.color-border;
            border-radius: 10px;
            visible: root.is-sso-awaiting-password && !root.is-vault-view && !root.is-tde-awaiting-approval;

            VerticalLayout {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 20px;
                padding-bottom: 20px;
                spacing: 10px;

                Text {
                    text: "SSO Login — Master Password Required";
                    color: root.color-text-primary;
                    font-size: 20px;
                    font-weight: 700;
                }

                Text {
                    text: "SSO authentication succeeded. Enter your master password to decrypt the vault.";
                    color: root.color-text-secondary;
                    font-size: 14px;
                    wrap: word-wrap;
                }

                Text {
                    text: "Master Password";
                    color: root.color-text-primary;
                    font-size: 14px;
                }

                LineEdit {
                    text <=> root.sso-master-password;
                    placeholder-text: "Enter your master password";
                    input-type: InputType.password;
                    enabled: !root.is-logging-in;
                }

                Text {
                    text: root.status-text;
                    color: root.status-is-error ? root.color-error : root.color-success;
                    font-size: 13px;
                    wrap: word-wrap;
                    visible: root.status-text != "";
                }

                Button {
                    text: root.is-logging-in ? "Decrypting vault..." : "Unlock";
                    enabled: !root.is-logging-in;
                    clicked => {
                        root.sso-master-password-submitted();
                    }
                }
            }
        }

        // ── TDE: waiting for device or admin approval ──────────────────────────
        Rectangle {
            width: parent.width > 700px ? 520px : parent.width - 80px;
            height: 380px;
            x: (parent.width - self.width) / 2;
            y: (parent.height - self.height) / 2;
            background: root.color-bg-panel;
            border-width: 1px;
            border-color: root.color-border;
            border-radius: 10px;
            visible: root.is-tde-awaiting-approval && !root.is-vault-view;

            VerticalLayout {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 20px;
                padding-bottom: 20px;
                spacing: 12px;

                Text {
                    text: "Approve from Another Device";
                    color: root.color-text-primary;
                    font-size: 20px;
                    font-weight: 700;
                }

                Text {
                    text: "A login approval request has been sent. Approve it from a trusted device or ask your organization admin to approve it in the admin console.";
                    color: root.color-text-secondary;
                    font-size: 14px;
                    wrap: word-wrap;
                }

                Text {
                    text: "Security Fingerprint";
                    color: root.color-text-primary;
                    font-size: 13px;
                    font-weight: 600;
                }

                Rectangle {
                    background: root.color-bg-elevated;
                    border-width: 1px;
                    border-color: root.color-border;
                    border-radius: 6px;
                    height: 48px;

                    Text {
                        text: root.tde-fingerprint != "" ? root.tde-fingerprint : "Generating…";
                        color: root.color-success;
                        font-size: 14px;
                        font-weight: 600;
                        vertical-alignment: center;
                        horizontal-alignment: center;
                    }
                }

                Text {
                    text: "Show this fingerprint to your approver to verify the request is legitimate.";
                    color: root.color-text-muted;
                    font-size: 12px;
                    wrap: word-wrap;
                }

                Text {
                    text: root.status-text;
                    color: root.status-is-error ? root.color-error : root.color-text-secondary;
                    font-size: 13px;
                    wrap: word-wrap;
                    visible: root.status-text != "";
                }

                HorizontalLayout {
                    spacing: 8px;

                    Rectangle {
                        horizontal-stretch: 1;
                        background: transparent;
                    }

                    Button {
                        text: "Cancel";
                        clicked => {
                            root.tde-approval-cancel-requested();
                        }
                    }
                }
            }
        }

        Rectangle {
            x: 40px;
            y: 40px;
            width: parent.width - 80px;
            height: parent.height - 80px;
            background: root.color-bg-panel;
            border-width: 1px;
            border-color: root.color-border;
            border-radius: 10px;
            visible: root.is-vault-view;

            VerticalLayout {
                padding-left: 24px;
                padding-right: 24px;
                padding-top: 20px;
                padding-bottom: 20px;
                spacing: 12px;

                Text {
                    text: "Bitwarden Vault";
                    color: root.color-text-primary;
                    font-size: 24px;
                    font-weight: 700;
                }

                HorizontalLayout {
                    spacing: 12px;
                    vertical-stretch: 1;

                    Rectangle {
                        width: 200px;
                        background: root.color-bg-elevated;
                        border-width: 1px;
                        border-color: root.color-border;
                        border-radius: 8px;

                        VerticalLayout {
                            padding-left: 12px;
                            padding-right: 12px;
                            padding-top: 12px;
                            padding-bottom: 12px;
                            spacing: 8px;

                            Text {
                                text: "Collections";
                                color: root.color-text-primary;
                                font-size: 14px;
                                font-weight: 700;
                            }

                            // "All Items" — clears any active collection filter
                            Rectangle {
                                height: 28px;
                                background: root.active-collection-id == "" ? root.color-accent-soft : transparent;
                                border-radius: 4px;

                                Text {
                                    text: "All Items";
                                    color: root.active-collection-id == "" ? root.color-text-primary : root.color-text-secondary;
                                    font-size: 13px;
                                    font-weight: root.active-collection-id == "" ? 600 : 400;
                                    vertical-alignment: center;
                                    x: 4px;
                                }

                                TouchArea {
                                    clicked => {
                                        root.collection-all-items-clicked();
                                    }
                                }
                            }

                            ListView {
                                vertical-stretch: 1;
                                for row[index] in root.collection-tree-rows: Rectangle {
                                    height: 28px;
                                    background: !row.has-children && root.active-collection-id == row.id ? root.color-accent-soft : transparent;
                                    border-radius: 4px;

                                    HorizontalLayout {
                                        spacing: 4px;

                                        Rectangle {
                                            width: row.depth * 14px;
                                            background: transparent;
                                        }

                                        Text {
                                            text: row.has-children ? (row.is-expanded ? "v" : ">") : "";
                                            color: root.color-text-muted;
                                            font-size: 12px;
                                            vertical-alignment: center;
                                            width: 12px;
                                        }

                                        Text {
                                            text: row.label;
                                            color: !row.has-children && root.active-collection-id == row.id ? root.color-text-primary : root.color-text-secondary;
                                            font-size: 13px;
                                            font-weight: !row.has-children && root.active-collection-id == row.id ? 600 : 400;
                                            vertical-alignment: center;
                                        }
                                    }

                                    TouchArea {
                                        clicked => {
                                            root.collection-tree-row-clicked(index);
                                        }
                                    }
                                }
                            }

                            Text {
                                text: root.collection-tree-rows.length > 0 ? "" : "No collections loaded.";
                                color: root.color-text-muted;
                                font-size: 12px;
                            }
                        }
                    }

                    Rectangle {
                        width: 300px;
                        background: root.color-bg-elevated;
                        border-width: 1px;
                        border-color: root.color-border;
                        border-radius: 8px;

                        VerticalLayout {
                            padding-left: 12px;
                            padding-right: 12px;
                            padding-top: 12px;
                            padding-bottom: 12px;
                            spacing: 8px;

                            Text {
                                text: "Vault Items";
                                color: root.color-text-primary;
                                font-size: 14px;
                                font-weight: 700;
                            }

                            HorizontalLayout {
                                spacing: 6px;

                                LineEdit {
                                    horizontal-stretch: 1;
                                    text <=> root.search-query;
                                    placeholder-text: "Search item names and fields";
                                }

                                Button {
                                    text: "Search";
                                    clicked => {
                                        root.search-requested();
                                    }
                                }
                            }

                            ListView {
                                vertical-stretch: 1;
                                for row[index] in root.vault-item-rows: Rectangle {
                                    height: 30px;
                                    background: root.selected-vault-item-index == index ? root.color-accent-soft : transparent;
                                    border-radius: 4px;

                                    Text {
                                        text: row.label;
                                        color: root.color-text-secondary;
                                        font-size: 13px;
                                        vertical-alignment: center;
                                    }

                                    TouchArea {
                                        clicked => {
                                            root.vault-item-clicked(index);
                                        }
                                    }
                                }
                            }

                            Text {
                                text: root.vault-item-rows.length > 0 ? "" : (root.has-active-search ? "No vault items match your search." : "No vault items loaded.");
                                color: root.color-text-muted;
                                font-size: 12px;
                            }
                        }
                    }

                    Rectangle {
                        horizontal-stretch: 1;
                        background: root.color-bg-subtle;
                        border-width: 1px;
                        border-color: root.color-border;
                        border-radius: 8px;

                        VerticalLayout {
                            padding-left: 12px;
                            padding-right: 12px;
                            padding-top: 12px;
                            padding-bottom: 12px;
                            spacing: 8px;

                            Text {
                                text: root.selected-vault-item-title != "" ? root.selected-vault-item-title : "Item Details";
                                color: root.color-text-primary;
                                font-size: 20px;
                                font-weight: 700;
                            }

                            Rectangle {
                                background: root.color-bg-card;
                                border-width: 1px;
                                border-color: root.color-border;
                                border-radius: 8px;
                                vertical-stretch: 1;

                                VerticalLayout {
                                    padding-left: 14px;
                                    padding-right: 14px;
                                    padding-top: 12px;
                                    padding-bottom: 12px;
                                    spacing: 8px;

                                    HorizontalLayout {
                                        spacing: 8px;

                                        Text {
                                            text: "Login Credentials";
                                            color: root.color-text-primary;
                                            font-size: 15px;
                                            font-weight: 700;
                                        }

                                        Rectangle {
                                            horizontal-stretch: 1;
                                            background: transparent;
                                        }

                                        Button {
                                            visible: root.selected-has-password;
                                            text: root.is-password-visible ? "Hide password" : "Show password";
                                            clicked => {
                                                root.toggle-password-visibility();
                                            }
                                        }
                                    }

                                    ListView {
                                        visible: root.selected-vault-item-fields.length > 0;
                                        vertical-stretch: 1;
                                        for row[index] in root.selected-vault-item-fields: Rectangle {
                                            background: transparent;
                                            height: 56px;

                                            VerticalLayout {
                                                padding-top: 6px;
                                                padding-bottom: 6px;
                                                spacing: 2px;

                                                Text {
                                                    text: row.label;
                                                    color: root.color-text-muted;
                                                    font-size: 12px;
                                                }

                                                Text {
                                                    text: row.value;
                                                    color: root.color-text-primary;
                                                    font-size: 15px;
                                                    font-weight: 600;
                                                    wrap: word-wrap;
                                                }
                                            }

                                            Rectangle {
                                                y: parent.height - 1px;
                                                width: parent.width;
                                                height: 1px;
                                                background: root.color-border;
                                                visible: index < root.selected-vault-item-fields.length - 1;
                                            }
                                        }
                                    }

                                    Text {
                                        visible: root.selected-vault-item-fields.length == 0;
                                        text: root.selected-vault-item-empty-text != "" ? root.selected-vault-item-empty-text : "Select an item to view details.";
                                        color: root.color-text-muted;
                                        font-size: 13px;
                                        wrap: word-wrap;
                                        vertical-stretch: 1;
                                    }
                                }
                            }

                            Rectangle {
                                background: root.color-bg-card;
                                border-width: 1px;
                                border-color: root.color-border;
                                border-radius: 8px;
                                height: 70px;

                                VerticalLayout {
                                    padding-left: 14px;
                                    padding-right: 14px;
                                    padding-top: 10px;
                                    padding-bottom: 10px;
                                    spacing: 3px;

                                    Text {
                                        text: "Item Metadata";
                                        color: root.color-text-muted;
                                        font-size: 12px;
                                        font-weight: 600;
                                    }

                                    Text {
                                        text: root.selected-vault-item-title != "" ? "Loaded decrypted fields from item data payload." : "No item selected.";
                                        color: root.color-text-secondary;
                                        font-size: 12px;
                                    }
                                }
                            }
                        }
                    }
                }
            }
        }
    }
}
